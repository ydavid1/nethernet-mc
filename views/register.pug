doctype html
html
  head
    title Login - NetherNet
    include includes/head
    link(rel='stylesheet', href='assets/css/login.css')
    script(src='https://www.google.com/recaptcha/api.js' async='' defer='')
  body
    include includes/body
    .container.text-center
      h1 NetherNet
      .login-card
        //- h1 NetherNet
        .login-options
          form#register(action="/api/register" method="POST")
            input(type="email" name="email" placeholder="Email" required)
            input(type="text" name="username" placeholder="Username" required pattern="[A-Za-z0-9]{5,}" title="Username must be at least 5 characters long and contain only letters and numbers.")
            input(type="password" name="password" placeholder="Password" required)
            .g-recaptcha(data-sitekey='6LcE__QpAAAAACoVQpOs9NKR0scCZCny4YzQSutO')
            button(type="submit") Register
          p Have an account?
          a(href="/login") Login
          //- script(src='assets/js/login.js')
          script.
            document.querySelector('#register').addEventListener('submit', async function(event) {
                event.preventDefault();
                var form = this;
                var formData = new FormData(form);
                console.log(formData.get('email'));
                
                if (formData.get('g-recaptcha-response') === '') {
                    Toastify({
                        text: "Please complete the reCAPTCHA",
                        duration: 5000,
                        close: true,
                        gravity: "top", // `top` or `bottom`
                        position: "right", // `left`, `center` or `right`
                        backgroundColor: "#ff0000",
                        stopOnFocus: true, // Prevents dismissing of toast on hover
                    }).showToast();
                    return;
                }

                await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        Accept: "application/json",
                        "Content-Type": "application/json"
                    },
                    body: await JSON.stringify({
                        email: formData.get('email'),
                        username: formData.get('username'),
                        password: formData.get('password'),
                        'g-recaptcha-response': formData.get('g-recaptcha-response')
                    })
                }).then(response => response.json()) // Convert the response to JSON
                .then(data => {
                    if (data.message === "Success") {
                        console.log('Registered');
                        window.location.href = '/login?registered=true';
                    } else {
                        console.log('Invalid registration');
                        grecaptcha.reset()
                        // make a toast saying invalid login
                        Toastify({
                            text: `${data.reason} `,
                            duration: 3000,
                            close: true,
                            gravity: "top", // `top` or `bottom`
                            position: "right", // `left`, `center` or `right`
                            backgroundColor: "#ff0000",
                            stopOnFocus: true, // Prevents dismissing of toast on hover
                        }).showToast();
                    }
                }).catch(err => {
                    console.log(err);
                });

            });
